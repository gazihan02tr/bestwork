{% extends 'bestsoft/inc/base.html' %}

{% block title %}Mesajlar - BestSoft Admin{% endblock %}

{% block page_title %}Mesajlar{% endblock %}
{% block page_subtitle %}İletişim formundan gelen mesajları yönetin{% endblock %}

{% block content %}
<div x-data="{ showModal: false, selectedMessage: null, filter: 'all' }" class="space-y-6">
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="m3-card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center">
                    <span class="material-symbols-rounded text-blue-600">mail</span>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900">{{ messages|length if messages else 0 }}</p>
                    <p class="text-xs text-gray-500">Toplam</p>
                </div>
            </div>
        </div>
        <div class="m3-card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center">
                    <span class="material-symbols-rounded text-amber-600">mark_email_unread</span>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900">{{ messages|selectattr('status', 'equalto', 'unread')|list|length if messages else 0 }}</p>
                    <p class="text-xs text-gray-500">Okunmamış</p>
                </div>
            </div>
        </div>
        <div class="m3-card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-green-100 flex items-center justify-center">
                    <span class="material-symbols-rounded text-green-600">check_circle</span>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900">{{ messages|selectattr('status', 'equalto', 'read')|list|length if messages else 0 }}</p>
                    <p class="text-xs text-gray-500">Okunmuş</p>
                </div>
            </div>
        </div>
        <div class="m3-card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center">
                    <span class="material-symbols-rounded text-purple-600">reply</span>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900">{{ messages|selectattr('replied')|list|length if messages else 0 }}</p>
                    <p class="text-xs text-gray-500">Yanıtlanmış</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filter Tabs -->
    <div class="flex gap-2 overflow-x-auto pb-2">
        <button 
            @click="filter = 'all'"
            :class="filter === 'all' ? 'bg-primary-100 text-primary-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
            class="px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap"
        >
            Tümü
        </button>
        <button 
            @click="filter = 'unread'"
            :class="filter === 'unread' ? 'bg-primary-100 text-primary-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
            class="px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap"
        >
            Okunmamış
        </button>
        <button 
            @click="filter = 'read'"
            :class="filter === 'read' ? 'bg-primary-100 text-primary-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
            class="px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap"
        >
            Okunmuş
        </button>
        <button 
            @click="filter = 'replied'"
            :class="filter === 'replied' ? 'bg-primary-100 text-primary-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
            class="px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap"
        >
            Yanıtlanmış
        </button>
    </div>
    
    <!-- Messages List -->
    <div class="m3-card divide-y divide-gray-100">
        {% if messages %}
            {% for msg in messages %}
            <div 
                class="p-5 hover:bg-gray-50 transition-colors cursor-pointer"
                @click="selectedMessage = {{ msg|tojson }}; showModal = true"
                x-show="filter === 'all' || filter === '{{ msg.status }}' || (filter === 'replied' && {{ 'true' if msg.replied else 'false' }})"
            >
                <div class="flex items-start gap-4">
                    <!-- Avatar -->
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center flex-shrink-0">
                        <span class="text-white font-bold text-lg">{{ msg.name[0]|upper if msg.name else 'M' }}</span>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-semibold text-gray-900">{{ msg.name }}</h3>
                            {% if msg.status == 'unread' %}
                                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                            {% endif %}
                            {% if msg.replied %}
                                <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-medium rounded-full">Yanıtlandı</span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-600 mb-1">{{ msg.subject or 'Konu belirtilmedi' }}</p>
                        <p class="text-sm text-gray-500 truncate">{{ msg.message[:100] }}...</p>
                        <div class="flex items-center gap-4 mt-2 text-xs text-gray-400">
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-rounded text-sm">mail</span>
                                {{ msg.email }}
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-rounded text-sm">schedule</span>
                                {{ msg.created_at.strftime('%d.%m.%Y %H:%M') if msg.created_at else '' }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex items-center gap-1">
                        <form action="{{ url_for('bestsoft_bp.message_delete', msg_id=msg._id) }}" method="POST" @click.stop onsubmit="return confirm('Bu mesajı silmek istediğinize emin misiniz?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="p-2 rounded-xl hover:bg-red-50 text-gray-400 hover:text-red-500 transition-colors">
                                <span class="material-symbols-rounded">delete</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- Empty State -->
            <div class="p-12 text-center">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                    <span class="material-symbols-rounded text-4xl text-gray-400">inbox</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Mesaj yok</h3>
                <p class="text-gray-500">Henüz iletişim formu üzerinden mesaj gelmemiş.</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Message Detail Modal -->
    <div 
        x-show="showModal && selectedMessage"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
        @click.self="showModal = false"
    >
        <div 
            x-show="showModal"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"
        >
            <template x-if="selectedMessage">
                <div>
                    <!-- Modal Header -->
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center">
                                    <span class="text-white font-bold text-xl" x-text="selectedMessage.name ? selectedMessage.name[0].toUpperCase() : 'M'"></span>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-900" x-text="selectedMessage.name"></h2>
                                    <p class="text-sm text-gray-500" x-text="selectedMessage.email"></p>
                                </div>
                            </div>
                            <button @click="showModal = false" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                                <span class="material-symbols-rounded text-gray-500">close</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal Body -->
                    <div class="p-6">
                        <div class="mb-4">
                            <span class="text-sm text-gray-500">Konu:</span>
                            <h3 class="text-lg font-semibold text-gray-900" x-text="selectedMessage.subject || 'Konu belirtilmedi'"></h3>
                        </div>
                        
                        <div class="bg-gray-50 rounded-2xl p-4 mb-6">
                            <p class="text-gray-700 whitespace-pre-wrap" x-text="selectedMessage.message"></p>
                        </div>
                        
                        <div class="flex items-center gap-4 text-sm text-gray-500">
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-rounded text-lg">schedule</span>
                                <span x-text="selectedMessage.created_at ? new Date(selectedMessage.created_at).toLocaleString('tr-TR') : ''"></span>
                            </span>
                            <template x-if="selectedMessage.phone">
                                <span class="flex items-center gap-1">
                                    <span class="material-symbols-rounded text-lg">phone</span>
                                    <span x-text="selectedMessage.phone"></span>
                                </span>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="p-6 bg-gray-50 border-t border-gray-100 flex gap-3">
                        <a :href="'mailto:' + selectedMessage.email" class="flex-1 m3-btn m3-btn-outlined">
                            <span class="material-symbols-rounded">mail</span>
                            E-posta Gönder
                        </a>
                        <button @click="showModal = false" class="flex-1 m3-btn m3-btn-filled">
                            Kapat
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}
